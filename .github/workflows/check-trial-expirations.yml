name: Check Trial Expirations Daily

# Ex√©cuter tous les jours √† 9h00 (UTC+1 = 8h00 UTC)
on:
  schedule:
    - cron: '0 8 * * *'  # 8h00 UTC = 9h00 UTC+1 (Paris)
  
  # Permettre l'ex√©cution manuelle pour les tests
  workflow_dispatch:

jobs:
  check-trials:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Trial Expirations
        run: |
          echo "üîç Checking trial expirations at $(date)"
          
          # Appeler l'endpoint tRPC via HTTP POST
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"secret\":\"${{ secrets.CRON_SECRET }}\"}" \
            "${{ secrets.APP_URL }}/api/trpc/cron.checkTrialExpirations")
          
          echo "üìß Response: $RESPONSE"
          
          # V√©rifier si la r√©ponse contient "success":true
          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ Trial expirations checked successfully"
            exit 0
          else
            echo "‚ùå Failed to check trial expirations"
            echo "Response: $RESPONSE"
            exit 1
          fi
      
      - name: Send notification on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Trial expiration check failed at $(date)"
          # Vous pouvez ajouter ici une notification (Slack, Discord, email, etc.)

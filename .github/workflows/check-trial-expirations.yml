name: Check Trial Expirations

# Ex√©cuter tous les jours √† 9h00 (UTC+1 = 8h00 UTC)
on:
  schedule:
    - cron: '0 8 * * *'  # 8h00 UTC = 9h00 UTC+1 (Paris)
  
  # Permettre l'ex√©cution manuelle pour les tests
  workflow_dispatch:

jobs:
  check-trials:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Trial Expirations
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "üîç V√©rification des essais gratuits qui expirent..."
          
          # V√©rifier que les variables sont configur√©es
          if [ -z "$APP_URL" ]; then
            echo "‚ùå Erreur : APP_URL n'est pas configur√© dans les secrets GitHub"
            exit 1
          fi
          
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå Erreur : CRON_SECRET n'est pas configur√© dans les secrets GitHub"
            exit 1
          fi
          
          # Appeler l'endpoint REST
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$APP_URL/api/cron/check-trial-expirations" \
            -H "Content-Type: application/json" \
            -d "{\"secret\":\"$CRON_SECRET\"}")
          
          # Extraire le code HTTP (derni√®re ligne)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          # Extraire le corps de la r√©ponse (tout sauf la derni√®re ligne)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "üìä Code HTTP : $HTTP_CODE"
          echo "üìÑ R√©ponse : $BODY"
          
          # V√©rifier le code de statut
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ T√¢che CRON ex√©cut√©e avec succ√®s"
            
            # Afficher les statistiques si disponibles
            if command -v jq &> /dev/null; then
              echo "$BODY" | jq -r '"üìß Emails J-7 : \(.results.j7.sent) envoy√©s, \(.results.j7.failed) √©chou√©s\nüìß Emails J-3 : \(.results.j3.sent) envoy√©s, \(.results.j3.failed) √©chou√©s\nüìß Emails J-1 : \(.results.j1.sent) envoy√©s, \(.results.j1.failed) √©chou√©s\nüìß Emails J-0 : \(.results.j0.sent) envoy√©s, \(.results.j0.failed) √©chou√©s"' 2>/dev/null || echo "$BODY"
            else
              echo "$BODY"
            fi
          else
            echo "‚ùå Erreur lors de l'ex√©cution de la t√¢che CRON"
            echo "R√©ponse compl√®te : $BODY"
            exit 1
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå La t√¢che CRON a √©chou√©. V√©rifiez les logs ci-dessus."
          echo "üîß Actions recommand√©es :"
          echo "  1. V√©rifiez que APP_URL est correct dans les secrets GitHub"
          echo "  2. V√©rifiez que CRON_SECRET correspond √† celui configur√© dans Manus"
          echo "  3. V√©rifiez que l'endpoint /api/cron/check-trial-expirations est accessible"
